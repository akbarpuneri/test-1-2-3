<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive CapEx Analysis Framework</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Subtle Corporate -->
    <!-- Application Structure Plan: The SPA is designed as a "CapEx Analysis Toolkit" dashboard. It transforms the linear report into a non-linear, exploratory experience. The core is an interactive "CapEx Lifecycle" diagram that provides a visual mental model of the entire process. Users can click elements on the diagram to navigate to detailed sections. Each section uses interactive elements‚Äîlike a mini NPV calculator and a dynamic risk matrix‚Äîto teach the concepts through hands-on engagement rather than passive reading. This structure was chosen to make the abstract framework and data schema from the source report tangible, understandable, and more memorable for the user, prioritizing learning-by-doing over simple information presentation. -->
    <!-- Visualization & Content Choices: The application uses a variety of interactive elements to explain the report's concepts. Historical data is shown with a Chart.js line chart to illustrate trends. Future projections use a stacked bar chart to break down financial components. The core concepts of NPV and IRR are taught with a live calculator, giving immediate feedback. The risk matrix is an interactive grid with sliders, making the relationship between likelihood, impact, and risk rating immediately clear. Finally, the report's key output‚Äîthe five data table structures‚Äîare presented in a clean, tabbed interface for easy reference. All visualizations are built with Chart.js on canvas or pure HTML/CSS/JS, fully avoiding SVG and Mermaid JS as required. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* slate-50 */
            color: #1e293b; /* slate-800 */
        }
        .nav-link {
            transition: color 0.3s, border-bottom-color 0.3s;
            border-bottom: 2px solid transparent;
        }
        .nav-link:hover, .nav-link.active {
            color: #2563eb; /* blue-600 */
            border-bottom-color: #2563eb;
        }
        .section-card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .section-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -2px rgb(0 0 0 / 0.1);
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            height: 320px;
            max-height: 400px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 400px;
            }
        }
        .risk-matrix-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            grid-template-rows: repeat(6, 1fr);
            gap: 0.5rem;
            aspect-ratio: 1/1;
            max-width: 500px;
        }
        .risk-cell {
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.375rem;
            font-weight: 600;
            transition: all 0.3s;
        }
        .risk-cell.highlight {
            transform: scale(1.1);
            z-index: 10;
            border: 2px solid #1e293b;
        }
        .tab-button.active {
            border-color: #2563eb;
            color: #2563eb;
            background-color: #eff6ff;
        }
    </style>
</head>
<body class="antialiased">

    <header class="bg-white/80 backdrop-blur-lg sticky top-0 z-30 shadow-sm">
        <nav class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex-shrink-0">
                    <h1 class="text-xl font-bold text-slate-800">CapEx Analysis Toolkit</h1>
                </div>
                <div class="hidden md:block">
                    <div class="ml-10 flex items-baseline space-x-4">
                        <a href="#data-upload" class="nav-link px-3 py-2 text-sm font-medium text-slate-600">Data Upload</a>
                        <a href="#lifecycle" class="nav-link px-3 py-2 text-sm font-medium text-slate-600">Lifecycle</a>
                        <a href="#components" class="nav-link px-3 py-2 text-sm font-medium text-slate-600">Components</a>
                        <a href="#evaluation" class="nav-link px-3 py-2 text-sm font-medium text-slate-600">Evaluation</a>
                        <a href="#risk" class="nav-link px-3 py-2 text-sm font-medium text-slate-600">Risk</a>
                        <a href="#schema" class="nav-link px-3 py-2 text-sm font-medium text-slate-600">Data Schema</a>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-8 md:py-12">

        <section id="intro" class="text-center mb-16">
            <h2 class="text-3xl md:text-4xl font-bold tracking-tight text-slate-900 mb-4">An Interactive Framework for Capital Expenditure Analysis</h2>
            <p class="max-w-3xl mx-auto text-lg text-slate-600">This application translates the principles of robust CapEx analysis into an interactive experience. Upload your CSV data to explore the key components, evaluate projects with live financial metrics, and understand the data structures needed for strategic investment decisions.</p>
        </section>

        <section id="data-upload" class="mb-20">
            <div class="text-center mb-10">
                <h3 class="text-2xl font-bold text-slate-800">Upload Your Data</h3>
                <p class="mt-2 text-md text-slate-500">To get started, please upload the required CSV files. Ensure your CSVs match the specified column headers.</p>
            </div>
            <div class="section-card p-6 grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div>
                    <label for="operatingAssetCsv" class="block text-sm font-medium text-slate-700 mb-2">1. Operating Asset Data (CSV)</label>
                    <input type="file" id="operatingAssetCsv" accept=".csv" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer">
                    <p class="text-xs text-slate-500 mt-2">Expected columns: <code class="font-mono">Year,Operating_Revenue,Operating_Expenses</code></p>
                </div>
                <div>
                    <label for="projectionCsv" class="block text-sm font-medium text-slate-700 mb-2">2. Projected Financials (CSV)</label>
                    <input type="file" id="projectionCsv" accept=".csv" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer">
                    <p class="text-xs text-slate-500 mt-2">Expected columns: <code class="font-mono">Year,Projected_Revenue,Projected_Operating_Costs</code></p>
                </div>
                <div>
                    <label for="cashflowCsv" class="block text-sm font-medium text-slate-700 mb-2">3. Cash Flows for NPV/IRR (CSV)</label>
                    <input type="file" id="cashflowCsv" accept=".csv" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer">
                    <p class="text-xs text-slate-500 mt-2">Expected columns: <code class="font-mono">Year,Cash_Flow</code> (Year 0 should be initial investment)</p>
                </div>
                <div class="md:col-span-2 lg:col-span-3 flex justify-center mt-4">
                    <button id="loadDataBtn" class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition-colors">Load All Data</button>
                </div>
                <div id="uploadStatus" class="md:col-span-2 lg:col-span-3 text-center text-sm mt-4 text-slate-600"></div>
            </div>
        </section>

        <section id="lifecycle" class="mb-20">
            <div class="text-center mb-10">
                <h3 class="text-2xl font-bold text-slate-800">The CapEx Lifecycle</h3>
                <p class="mt-2 text-md text-slate-500">From initial idea to final evaluation, capital expenditure follows a structured process. Click on any stage below to jump to the detailed section.</p>
            </div>
            <div class="relative flex flex-col md:flex-row items-center justify-center gap-4 md:gap-0">
                <a href="#components" class="p-4 bg-white rounded-lg shadow-md text-center w-48 hover:shadow-xl transition-shadow">
                    <div class="text-4xl">üè¢</div>
                    <h4 class="font-semibold mt-2">1. Core Components</h4>
                    <p class="text-xs text-slate-500">Operating Assets & New Projects</p>
                </a>
                <div class="text-2xl text-slate-400 mx-4 hidden md:block">‚Üí</div>
                 <div class="text-2xl text-slate-400 my-2 md:hidden">‚Üì</div>
                <a href="#evaluation" class="p-4 bg-white rounded-lg shadow-md text-center w-48 hover:shadow-xl transition-shadow">
                    <div class="text-4xl">üìà</div>
                    <h4 class="font-semibold mt-2">2. Financial Projections</h4>
                    <p class="text-xs text-slate-500">Forecasting Future Performance</p>
                </a>
                <div class="text-2xl text-slate-400 mx-4 hidden md:block">‚Üí</div>
                <div class="text-2xl text-slate-400 my-2 md:hidden">‚Üì</div>
                <a href="#evaluation" class="p-4 bg-white rounded-lg shadow-md text-center w-48 hover:shadow-xl transition-shadow">
                    <div class="text-4xl">‚öñÔ∏è</div>
                    <h4 class="font-semibold mt-2">3. Evaluation Engine</h4>
                    <p class="text-xs text-slate-500">Metrics like NPV & IRR</p>
                </a>
                 <div class="text-2xl text-slate-400 mx-4 hidden md:block">‚Üí</div>
                 <div class="text-2xl text-slate-400 my-2 md:hidden">‚Üì</div>
                 <a href="#risk" class="p-4 bg-white rounded-lg shadow-md text-center w-48 hover:shadow-xl transition-shadow">
                    <div class="text-4xl">‚ö†Ô∏è</div>
                    <h4 class="font-semibold mt-2">4. Risk Assessment</h4>
                    <p class="text-xs text-slate-500">Quantifying Uncertainty</p>
                </a>
            </div>
        </section>

        <section id="components" class="mb-20 space-y-12">
            <div class="text-center">
                <h3 class="text-2xl font-bold text-slate-800">Core Components</h3>
                <p class="mt-2 text-md text-slate-500">CapEx decisions start with understanding current performance and defining future projects.</p>
            </div>
            <div class="grid md:grid-cols-2 gap-8 items-start">
                <div class="section-card p-6">
                    <h4 class="text-xl font-semibold mb-3">Operating Asset Performance</h4>
                    <p class="text-slate-600 mb-4">Analyzing the historical revenue and expenses of existing assets provides a baseline for future projections and helps identify needs for replacement or upgrades. This chart shows a sample trend for a single asset, updated from your uploaded data.</p>
                    <div class="chart-container">
                        <canvas id="operatingAssetChart"></canvas>
                    </div>
                </div>
                <div class="section-card p-6">
                    <h4 class="text-xl font-semibold mb-3">Defining a CapEx Project</h4>
                    <p class="text-slate-600 mb-4">Each project must be clearly defined with its cost, purpose, and the type of asset being created. This context is crucial for strategic alignment and financial modeling. (This section uses static mock data for project definition; financial projections come from your CSV.)</p>
                    <div class="bg-slate-50 p-4 rounded-lg space-y-3">
                        <div><strong class="text-slate-700">Project ID:</strong> <span class="font-mono text-sm bg-slate-200 px-2 py-1 rounded">P_001_New_Warehouse</span></div>
                        <div><strong class="text-slate-700">Project Name:</strong> <span>West Coast Distribution Center</span></div>
                        <div><strong class="text-slate-700">Projected CapEx:</strong> <span>$5,000,000</span></div>
                        <div><strong class="text-slate-700">Asset Type:</strong> <span>Building</span></div>
                        <div><strong class="text-slate-700">Purpose:</strong> <span class="bg-blue-100 text-blue-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full">Growth/Expansion</span></div>
                    </div>
                </div>
            </div>
        </section>

        <section id="evaluation" class="mb-20 space-y-12">
            <div class="text-center">
                <h3 class="text-2xl font-bold text-slate-800">The Evaluation Engine</h3>
                <p class="mt-2 text-md text-slate-500">Here we project future cash flows and use key financial metrics to determine a project's viability.</p>
            </div>
            <div class="section-card p-6 mb-8">
                <h4 class="text-xl font-semibold mb-3">Projected Financial Performance</h4>
                <p class="text-slate-600 mb-4">Once a project is defined, we forecast its future revenues and costs. The resulting net cash flow is the basis for all valuation metrics. This chart shows a 10-year projection for our new warehouse project, updated from your uploaded data.</p>
                <div class="chart-container">
                    <canvas id="projectionChart"></canvas>
                </div>
            </div>
            <div class="section-card p-6">
                <h4 class="text-xl font-semibold mb-3">Interactive Metrics Calculator (NPV & IRR)</h4>
                <p class="text-slate-600 mb-4">Net Present Value (NPV) and Internal Rate of Return (IRR) are essential for assessing profitability. NPV tells us the value a project adds in today's dollars, while IRR is the project's expected rate of return. Adjust the cash flows or discount rate below to see how they impact the results. Cash flows are loaded from your CSV.</p>
                <div class="grid md:grid-cols-3 gap-6">
                    <div class="md:col-span-2 space-y-4">
                        <div class="flex items-center space-x-2">
                            <label for="discountRate" class="font-medium text-slate-700 w-32">Discount Rate:</label>
                            <input type="number" id="discountRate" value="10" class="w-24 p-2 border rounded-md">
                            <span>%</span>
                        </div>
                        <div class="space-y-2" id="cashflow-inputs">
                            <p class="text-slate-500">Upload Cash Flow CSV to populate inputs.</p>
                        </div>
                    </div>
                    <div class="bg-slate-50 p-4 rounded-lg flex flex-col justify-center items-center text-center">
                        <div class="mb-4">
                            <h5 class="text-lg font-semibold text-slate-800">Net Present Value (NPV)</h5>
                            <p id="npv-result" class="text-3xl font-bold text-blue-600">$0</p>
                        </div>
                        <div>
                            <h5 class="text-lg font-semibold text-slate-800">Internal Rate of Return (IRR)</h5>
                            <p id="irr-result" class="text-3xl font-bold text-green-600">0%</p>
                        </div>
                        <p id="decision-rule" class="mt-4 text-sm font-medium text-slate-600"></p>
                    </div>
                </div>
            </div>
        </section>

        <section id="risk" class="mb-20">
            <div class="text-center">
                <h3 class="text-2xl font-bold text-slate-800">Risk Assessment</h3>
                <p class="mt-2 text-md text-slate-500">Quantifying risk is key to making robust investment decisions.</p>
            </div>
            <div class="section-card p-6 mt-8">
                <h4 class="text-xl font-semibold mb-3">Interactive Project Risk Matrix</h4>
                <p class="text-slate-600 mb-4">A risk matrix helps visualize and prioritize project risks based on their likelihood and potential impact. Use the sliders to select a likelihood and impact score, and see how the risk rating changes. High-rated risks require immediate attention and mitigation planning.</p>
                <div class="grid md:grid-cols-2 gap-8 items-center">
                    <div>
                        <div class="space-y-4">
                            <div>
                                <label for="likelihood-slider" class="block mb-2 font-medium text-slate-700">Likelihood: <span id="likelihood-value" class="font-bold">3</span></label>
                                <input id="likelihood-slider" type="range" min="1" max="5" value="3" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                            </div>
                            <div>
                                <label for="impact-slider" class="block mb-2 font-medium text-slate-700">Impact: <span id="impact-value" class="font-bold">3</span></label>
                                <input id="impact-slider" type="range" min="1" max="5" value="3" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                            </div>
                        </div>
                        <div class="mt-6 bg-slate-50 p-4 rounded-lg text-center">
                            <h5 class="text-lg font-semibold text-slate-800">Risk Rating</h5>
                            <p class="text-3xl font-bold" id="risk-rating">9</p>
                            <p class="text-xl font-semibold" id="risk-category">Medium</p>
                        </div>
                    </div>
                    <div class="flex justify-center items-center">
                        <div id="risk-matrix" class="risk-matrix-grid"></div>
                    </div>
                </div>
            </div>
        </section>

        <section id="schema">
            <div class="text-center">
                <h3 class="text-2xl font-bold text-slate-800">Data Schema Explorer</h3>
                <p class="mt-2 text-md text-slate-500">A successful analysis relies on well-structured data. Explore the required CSV data structures below.</p>
            </div>
            <div class="w-full max-w-4xl mx-auto mt-8">
                <div class="mb-4 flex flex-wrap justify-center border-b border-gray-200">
                    <button class="tab-button flex-grow md:flex-grow-0 text-sm font-medium text-center text-gray-500 border-b-2 border-transparent px-4 py-2 hover:text-gray-600 hover:border-gray-300" data-target="table1">Operating Assets</button>
                    <button class="tab-button flex-grow md:flex-grow-0 text-sm font-medium text-center text-gray-500 border-b-2 border-transparent px-4 py-2 hover:text-gray-600 hover:border-gray-300" data-target="table2">CapEx Projects</button>
                    <button class="tab-button flex-grow md:flex-grow-0 text-sm font-medium text-center text-gray-500 border-b-2 border-transparent px-4 py-2 hover:text-gray-600 hover:border-gray-300" data-target="table3">Metrics Inputs</button>
                    <button class="tab-button flex-grow md:flex-grow-0 text-sm font-medium text-center text-gray-500 border-b-2 border-transparent px-4 py-2 hover:text-gray-600 hover:border-gray-300" data-target="table4">Risk Matrix</button>
                    <button class="tab-button flex-grow md:flex-grow-0 text-sm font-medium text-center text-gray-500 border-b-2 border-transparent px-4 py-2 hover:text-gray-600 hover:border-gray-300" data-target="table5">New Asset Projections</button>
                </div>
                <div id="tab-content" class="bg-white p-6 rounded-lg shadow-md">
                </div>
            </div>
        </section>

    </main>

    <footer class="bg-slate-800 text-slate-300 mt-16">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-4 text-center text-sm">
            <p>Interactive CapEx Analysis Framework | Built to demonstrate concepts from the source report.</p>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            let operatingAssetData = null;
            let projectionData = null;
            let cashflowData = null;

            const uploadStatusEl = document.getElementById('uploadStatus');

            const schemas = {
                table1: {
                    title: 'Table 1: Operating Asset Financials',
                    description: 'Captures historical or current operating performance of existing assets. It provides contextual baseline data for overall business health and informs assumptions for new asset projections.',
                    columns: [
                        { name: 'Year', type: 'Integer', desc: 'The year for the financial data.' },
                        { name: 'Operating_Revenue', type: 'Numeric, USD', desc: 'Revenue generated directly from this asset\'s primary business activities.' },
                        { name: 'Operating_Expenses', type: 'Numeric, USD', desc: 'Day-to-day costs incurred to run this specific asset.' }
                    ]
                },
                table2: {
                    title: 'Table 2: Capital Expenditure Project Data',
                    description: 'Defines, quantifies, and categorizes proposed capital expenditure projects, providing the initial investment data crucial for project evaluation.',
                    columns: [
                        { name: 'Project_ID', type: 'String', desc: 'A unique identifier for each distinct CapEx project.' },
                        { name: 'Project_Name', type: 'String', desc: 'A descriptive name for the capital expenditure project.' },
                        { name: 'Projected_CapEx_Amount', type: 'Numeric, USD', desc: 'The total estimated capital expenditure for this specific project.' },
                        { name: 'Year_of_Expenditure', type: 'Integer', desc: 'The calendar year in which the primary capital expenditure is expected to occur.' },
                        { name: 'Asset_Type', type: 'String', desc: 'The primary type of asset being acquired or significantly upgraded.' },
                        { name: 'Purpose_of_CapEx', type: 'String', desc: 'The main strategic reason behind the expenditure.' }
                    ]
                },
                table3: {
                    title: 'Table 3: Financial Metrics Input Data',
                    description: 'Provides the necessary time-series cash flow data and discount rates required for the calculation of key CapEx financial metrics.',
                    columns: [
                        { name: 'Project_ID', type: 'String', desc: 'Links to the CapEx project defined in Table 2.' },
                        { name: 'Year', type: 'Integer', desc: 'The year of the cash flow relative to the project\'s start (Year 0 is initial investment).' },
                        { name: 'Cash_Flow', type: 'Numeric, USD', desc: 'The net cash flow generated by the project in that specific year.' },
                        { name: 'Initial_Investment', type: 'Numeric, USD', desc: 'The total initial capital outlay for the project.' },
                        { name: 'Discount_Rate_Project', type: 'Numeric, %', desc: 'The specific discount rate used for this project.' }
                    ]
                },
                table4: {
                    title: 'Table 4: Project Risk Matrix Data',
                    description: 'Quantifies and categorizes the key risks associated with each capital expenditure project, enabling structured risk assessment and prioritization.',
                    columns: [
                        { name: 'Project_ID', type: 'String', desc: 'Links to the CapEx project.' },
                        { name: 'Risk_ID', type: 'String', desc: 'A unique identifier for each specific risk identified.' },
                        { name: 'Risk_Description', type: 'String', desc: 'A concise description of the potential risk.' },
                        { name: 'Likelihood_Score', type: 'Integer (1-5)', desc: 'A score representing the probability of the risk occurring.' },
                        { name: 'Impact_Score', type: 'Integer (1-5)', desc: 'A score representing the severity of the consequence if the risk occurs.' },
                        { name: 'Risk_Rating', type: 'Integer (1-25)', desc: 'The calculated risk rating (Likelihood x Impact).' },
                        { name: 'Risk_Category', type: 'String', desc: 'A qualitative classification of the Risk_Rating (e.g., Low, Medium, High).' }
                    ]
                },
                table5: {
                    title: 'Table 5: New Asset Financial Projections',
                    description: 'Provides detailed, year-by-year financial projections for the revenue and costs specifically associated with the new asset.',
                    columns: [
                        { name: 'Project_ID', type: 'String', desc: 'Links to the CapEx project.' },
                        { name: 'Year', type: 'Integer', desc: 'The projection year, relative to the asset becoming operational.' },
                        { name: 'Projected_Revenue', type: 'Numeric, USD', desc: 'The gross revenue directly attributable to the new asset\'s operation.' },
                        { name: 'Projected_Operating_Costs', type: 'Numeric, USD', desc: 'All operating expenses directly associated with running the new asset.' },
                        { name: 'Net_Cash_Flow_from_Asset', type: 'Numeric, USD', desc: 'The calculated net cash flow derived directly from the asset\'s operations.' }
                    ]
                }
            };
            
            Chart.defaults.font.family = "'Inter', sans-serif";

            function formatCurrency(value) {
                return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(value);
            }

            function parseCSV(csvText) {
                const lines = csvText.trim().split('\n');
                if (lines.length === 0) return [];
                const headers = lines[0].split(',').map(h => h.trim());
                return lines.slice(1).map(line => {
                    const values = line.split(',').map(v => v.trim());
                    const obj = {};
                    headers.forEach((header, i) => {
                        obj[header] = values[i];
                    });
                    return obj;
                });
            }

            function processOperatingAssetCSV(parsedData) {
                const labels = [];
                const revenue = [];
                const expenses = [];
                parsedData.forEach(row => {
                    labels.push(row.Year);
                    revenue.push(parseFloat(row.Operating_Revenue));
                    expenses.push(parseFloat(row.Operating_Expenses));
                });
                return { labels, revenue, expenses };
            }

            function processProjectionCSV(parsedData) {
                const labels = [];
                const revenue = [];
                const costs = [];
                parsedData.forEach(row => {
                    labels.push(`Year ${row.Year}`);
                    revenue.push(parseFloat(row.Projected_Revenue));
                    costs.push(parseFloat(row.Projected_Operating_Costs));
                });
                return { labels, revenue, costs };
            }

            function processCashFlowCSV(parsedData) {
                return parsedData.map(row => parseFloat(row.Cash_Flow));
            }

            let operatingAssetChartInstance = null;
            function createOperatingAssetChart(data) {
                if (operatingAssetChartInstance) {
                    operatingAssetChartInstance.destroy();
                }
                const ctx = document.getElementById('operatingAssetChart').getContext('2d');
                operatingAssetChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            label: 'Operating Revenue',
                            data: data.revenue,
                            borderColor: '#2563eb',
                            backgroundColor: 'rgba(37, 99, 235, 0.1)',
                            fill: true,
                            tension: 0.3
                        }, {
                            label: 'Operating Expenses',
                            data: data.expenses,
                            borderColor: '#db2777',
                            backgroundColor: 'rgba(219, 39, 119, 0.1)',
                            fill: true,
                            tension: 0.3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                ticks: {
                                    callback: function(value) { return '$' + value / 1000 + 'K'; }
                                }
                            }
                        }
                    }
                });
            }

            let projectionChartInstance = null;
            function createProjectionChart(data) {
                if (projectionChartInstance) {
                    projectionChartInstance.destroy();
                }
                const ctx = document.getElementById('projectionChart').getContext('2d');
                const netCashFlow = data.revenue.map((rev, i) => rev - data.costs[i]);
                projectionChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            label: 'Projected Revenue',
                            data: data.revenue,
                            backgroundColor: '#34d399',
                        }, {
                            label: 'Projected Costs',
                            data: data.costs,
                            backgroundColor: '#f87171',
                        }, {
                            label: 'Net Cash Flow',
                            data: netCashFlow,
                            backgroundColor: '#60a5fa',
                            type: 'line',
                            borderColor: '#2563eb',
                            tension: 0.3,
                            fill: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: { stacked: true },
                            y: { 
                                stacked: true,
                                ticks: {
                                    callback: function(value) { return '$' + value / 1000 + 'K'; }
                                }
                            }
                        }
                    }
                });
            }

            function initCalculator(cashflows) {
                const cashflowInputsContainer = document.getElementById('cashflow-inputs');
                const discountRateInput = document.getElementById('discountRate');
                
                function setupInputs(cfs) {
                    cashflowInputsContainer.innerHTML = '';
                    if (!cfs || cfs.length === 0) {
                        cashflowInputsContainer.innerHTML = '<p class="text-slate-500">Upload Cash Flow CSV to populate inputs.</p>';
                        return;
                    }
                    cfs.forEach((cf, index) => {
                        const div = document.createElement('div');
                        div.className = 'flex items-center space-x-2';
                        const label = document.createElement('label');
                        label.className = 'font-medium text-slate-700 w-32';
                        label.textContent = `Year ${index} Cash Flow:`;
                        const input = document.createElement('input');
                        input.type = 'number';
                        input.className = 'cashflow-input w-48 p-2 border rounded-md';
                        input.value = cf;
                        div.appendChild(label);
                        div.appendChild(input);
                        cashflowInputsContainer.appendChild(div);
                    });
                }

                function calculate() {
                    const cfs = Array.from(document.getElementsByClassName('cashflow-input')).map(input => parseFloat(input.value) || 0);
                    const rate = parseFloat(discountRateInput.value) / 100 || 0;

                    let npv = 0;
                    for (let i = 0; i < cfs.length; i++) {
                        npv += cfs[i] / Math.pow(1 + rate, i);
                    }

                    let irr = calculateIRR(cfs);

                    document.getElementById('npv-result').textContent = formatCurrency(npv);
                    document.getElementById('irr-result').textContent = (irr * 100).toFixed(2) + '%';
                    
                    const decisionRuleEl = document.getElementById('decision-rule');
                    if (npv > 0) {
                        decisionRuleEl.textContent = 'Positive NPV suggests the project is financially viable.';
                        decisionRuleEl.className = 'mt-4 text-sm font-medium text-green-700';
                    } else {
                        decisionRuleEl.textContent = 'Negative NPV suggests the project may not be viable.';
                        decisionRuleEl.className = 'mt-4 text-sm font-medium text-red-700';
                    }
                }

                function calculateIRR(cfs, guess = 0.1) {
                    const maxIterations = 100;
                    const precision = 1e-7;
                    let x0 = guess;

                    for (let i = 0; i < maxIterations; i++) {
                        let npv = 0;
                        let derivative = 0;
                        for (let t = 0; t < cfs.length; t++) {
                            npv += cfs[t] / Math.pow(1 + x0, t);
                            derivative -= t * cfs[t] / Math.pow(1 + x0, t + 1);
                        }
                        if (Math.abs(npv) < precision) return x0;
                        if (derivative === 0) break;
                        x0 = x0 - npv / derivative;
                    }
                    return NaN; 
                }
                
                setupInputs(cashflows);
                calculate();
                cashflowInputsContainer.addEventListener('input', calculate);
                discountRateInput.addEventListener('input', calculate);
            }

            function initRiskMatrix() {
                const matrixContainer = document.getElementById('risk-matrix');
                const likelihoodSlider = document.getElementById('likelihood-slider');
                const impactSlider = document.getElementById('impact-slider');
                const likelihoodValue = document.getElementById('likelihood-value');
                const impactValue = document.getElementById('impact-value');
                const riskRatingEl = document.getElementById('risk-rating');
                const riskCategoryEl = document.getElementById('risk-category');

                const likelihoodLabels = ['Rare', 'Unlikely', 'Possible', 'Likely', 'Certain'];
                const impactLabels = ['Trivial', 'Minor', 'Moderate', 'Major', 'Severe'];

                function createMatrix() {
                    matrixContainer.innerHTML = '';
                    const headers = ['', ...impactLabels];
                    headers.forEach(h => {
                        const cell = document.createElement('div');
                        cell.className = 'text-xs font-bold text-slate-500 text-center transform -rotate-45';
                        cell.textContent = h;
                        matrixContainer.appendChild(cell);
                    });

                    for (let i = 5; i >= 1; i--) {
                        const rowLabel = document.createElement('div');
                        rowLabel.className = 'text-xs font-bold text-slate-500 text-center flex items-center justify-center';
                        rowLabel.textContent = likelihoodLabels[i-1];
                        matrixContainer.appendChild(rowLabel);
                        for (let j = 1; j <= 5; j++) {
                            const cell = document.createElement('div');
                            cell.id = `risk-cell-${i}-${j}`;
                            cell.className = 'risk-cell';
                            cell.textContent = i * j;
                            matrixContainer.appendChild(cell);
                        }
                    }
                }

                function updateMatrix() {
                    const likelihood = parseInt(likelihoodSlider.value);
                    const impact = parseInt(impactSlider.value);
                    const rating = likelihood * impact;

                    likelihoodValue.textContent = `${likelihood} (${likelihoodLabels[likelihood-1]})`;
                    impactValue.textContent = `${impact} (${impactLabels[impact-1]})`;
                    riskRatingEl.textContent = rating;

                    let category, color;
                    if (rating >= 15) { category = 'High'; color = 'bg-red-500'; } 
                    else if (rating >= 7) { category = 'Medium'; color = 'bg-yellow-400'; } 
                    else { category = 'Low'; color = 'bg-green-400'; }
                    
                    riskCategoryEl.textContent = category;
                    riskCategoryEl.className = `text-xl font-semibold text-white px-4 py-1 rounded-full ${color}`;
                    riskRatingEl.style.color = color.replace('bg-', '').replace('-500', '-600').replace('-400', '-500');


                    document.querySelectorAll('.risk-cell').forEach(c => {
                        c.classList.remove('highlight');
                        const r = parseInt(c.textContent);
                        if (r >= 15) c.style.backgroundColor = '#fecaca'; // red-200
                        else if (r >= 7) c.style.backgroundColor = '#fef08a'; // yellow-200
                        else c.style.backgroundColor = '#bbf7d0'; // green-200
                    });

                    const activeCell = document.getElementById(`risk-cell-${likelihood}-${impact}`);
                    if (activeCell) {
                        activeCell.classList.add('highlight');
                        activeCell.style.backgroundColor = color;
                    }
                }

                createMatrix();
                updateMatrix();
                likelihoodSlider.addEventListener('input', updateMatrix);
                impactSlider.addEventListener('input', updateMatrix);
            }

            function initTabs() {
                const tabButtons = document.querySelectorAll('.tab-button');
                const tabContent = document.getElementById('tab-content');

                function displayTabContent(targetId) {
                    const schema = schemas[targetId];
                    if (!schema) return;

                    let contentHTML = `<h4 class="text-xl font-semibold mb-2">${schema.title}</h4>`;
                    contentHTML += `<p class="text-slate-600 mb-6">${schema.description}</p>`;
                    contentHTML += `<div class="overflow-x-auto"><table class="w-full text-sm text-left text-slate-500">`;
                    contentHTML += `<thead class="text-xs text-slate-700 uppercase bg-slate-50"><tr>
                        <th scope="col" class="px-6 py-3">Column Name</th>
                        <th scope="col" class="px-6 py-3">Data Type</th>
                        <th scope="col" class="px-6 py-3">Description</th>
                        </tr></thead><tbody>`;
                    
                    schema.columns.forEach(col => {
                        contentHTML += `<tr class="bg-white border-b">
                            <th scope="row" class="px-6 py-4 font-medium text-slate-900 whitespace-nowrap">${col.name}</th>
                            <td class="px-6 py-4 font-mono text-xs">${col.type}</td>
                            <td class="px-6 py-4">${col.desc}</td>
                        </tr>`;
                    });

                    contentHTML += `</tbody></table></div>`;
                    tabContent.innerHTML = contentHTML;
                }

                tabButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        tabButtons.forEach(btn => btn.classList.remove('active'));
                        button.classList.add('active');
                        displayTabContent(button.dataset.target);
                    });
                });
                
                tabButtons[0].click();
            }

            // Initial rendering with empty data or default placeholders
            createOperatingAssetChart({ labels: [], revenue: [], expenses: [] });
            createProjectionChart({ labels: [], revenue: [], costs: [] });
            initCalculator([]);
            initRiskMatrix();
            initTabs();

            // Data Upload Logic
            document.getElementById('loadDataBtn').addEventListener('click', async () => {
                uploadStatusEl.textContent = 'Loading data...';
                uploadStatusEl.className = 'md:col-span-2 lg:col-span-3 text-center text-sm mt-4 text-blue-600';

                const operatingAssetFile = document.getElementById('operatingAssetCsv').files[0];
                const projectionFile = document.getElementById('projectionCsv').files[0];
                const cashflowFile = document.getElementById('cashflowCsv').files[0];

                let allLoaded = true;

                if (operatingAssetFile) {
                    try {
                        const text = await operatingAssetFile.text();
                        operatingAssetData = processOperatingAssetCSV(parseCSV(text));
                        createOperatingAssetChart(operatingAssetData);
                    } catch (error) {
                        uploadStatusEl.textContent = `Error loading Operating Asset data: ${error.message}`;
                        uploadStatusEl.className = 'md:col-span-2 lg:col-span-3 text-center text-sm mt-4 text-red-600';
                        allLoaded = false;
                    }
                } else {
                    uploadStatusEl.textContent = 'Operating Asset CSV not provided. Chart will be empty.';
                    uploadStatusEl.className = 'md:col-span-2 lg:col-span-3 text-center text-sm mt-4 text-orange-600';
                    createOperatingAssetChart({ labels: [], revenue: [], expenses: [] });
                }

                if (projectionFile) {
                    try {
                        const text = await projectionFile.text();
                        projectionData = processProjectionCSV(parseCSV(text));
                        createProjectionChart(projectionData);
                    } catch (error) {
                        uploadStatusEl.textContent = `Error loading Projection data: ${error.message}`;
                        uploadStatusEl.className = 'md:col-span-2 lg:col-span-3 text-center text-sm mt-4 text-red-600';
                        allLoaded = false;
                    }
                } else {
                    uploadStatusEl.textContent = 'Projected Financials CSV not provided. Chart will be empty.';
                    uploadStatusEl.className = 'md:col-span-2 lg:col-span-3 text-center text-sm mt-4 text-orange-600';
                    createProjectionChart({ labels: [], revenue: [], costs: [] });
                }

                if (cashflowFile) {
                    try {
                        const text = await cashflowFile.text();
                        cashflowData = processCashFlowCSV(parseCSV(text));
                        initCalculator(cashflowData);
                    } catch (error) {
                        uploadStatusEl.textContent = `Error loading Cash Flow data: ${error.message}`;
                        uploadStatusEl.className = 'md:col-span-2 lg:col-span-3 text-center text-sm mt-4 text-red-600';
                        allLoaded = false;
                    }
                } else {
                    uploadStatusEl.textContent = 'Cash Flows CSV not provided. Calculator will be empty.';
                    uploadStatusEl.className = 'md:col-span-2 lg:col-span-3 text-center text-sm mt-4 text-orange-600';
                    initCalculator([]);
                }

                if (allLoaded) {
                    uploadStatusEl.textContent = 'All data loaded successfully!';
                    uploadStatusEl.className = 'md:col-span-2 lg:col-span-3 text-center text-sm mt-4 text-green-600';
                }
            });
        });
    </script>
</body>
</html>
